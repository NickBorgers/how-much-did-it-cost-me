name: PR Reviews

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to test (branch, tag, or SHA)'
        required: false
        default: ''

permissions:
  contents: read
  pull-requests: write
  issues: read
  id-token: write
  packages: write

env:
  # Note: must be lowercase for Docker compatibility
  DEVCONTAINER_IMAGE: ghcr.io/nickborgers/how-much-did-it-cost-me-devcontainer

jobs:
  # Job: Build and cache devcontainer image
  # This saves time in subsequent jobs by reusing the prebuilt image
  build-devcontainer:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.head_ref || github.ref }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push devcontainer
        uses: devcontainers/ci@v0.3
        with:
          imageName: ${{ env.DEVCONTAINER_IMAGE }}
          cacheFrom: ${{ env.DEVCONTAINER_IMAGE }}
          push: always

  # Job 0: Check if PR author is authorized to trigger Claude reviews
  # This prevents arbitrary users from submitting PRs that could trick Claude
  # into visiting malicious URLs or executing harmful actions
  check-author-authorization:
    name: Check Author Authorization
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.check-auth.outputs.authorized }}
    steps:
      - name: Check if author is authorized
        id: check-auth
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          REPO="${{ github.repository }}"

          echo "Checking authorization for PR author: $PR_AUTHOR"

          # Check if author has write access (collaborator, member, or owner)
          PERMISSION=$(gh api "repos/$REPO/collaborators/$PR_AUTHOR/permission" --jq '.permission' 2>/dev/null || echo "none")

          echo "Author permission level: $PERMISSION"

          # Authorized if author has write, maintain, or admin access
          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "maintain" || "$PERMISSION" == "write" ]]; then
            echo "✓ Author $PR_AUTHOR is authorized (permission: $PERMISSION)"
            echo "authorized=true" >> $GITHUB_OUTPUT
          else
            echo "✗ Author $PR_AUTHOR is NOT authorized (permission: $PERMISSION)"
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo ""
            echo "::warning::PR author $PR_AUTHOR does not have write access. Claude review jobs will be skipped for security."
          fi

  # Job 1: Run unit tests for calculation logic
  # This ensures core calculation functions are correct before any other checks
  # Uses devcontainer with Node.js pre-installed
  run-unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build-devcontainer
    if: github.event.pull_request.draft != true
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.head_ref || github.ref }}

      - name: Create gh config directory for devcontainer mount
        run: mkdir -p ~/.config/gh

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run unit tests in devcontainer
        uses: devcontainers/ci@v0.3
        with:
          imageName: ${{ env.DEVCONTAINER_IMAGE }}
          cacheFrom: ${{ env.DEVCONTAINER_IMAGE }}
          push: never
          runCmd: |
            npm install
            npm test

  # Job 2: Run Playwright tests automatically (no Claude)
  # This runs the test script and saves results as an artifact
  # Uses prebuilt devcontainer with Playwright already installed
  run-playwright-tests:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    needs: build-devcontainer
    if: github.event.pull_request.draft != true
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.head_ref || github.ref }}

      - name: Create gh config directory for devcontainer mount
        run: mkdir -p ~/.config/gh

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Playwright tests in devcontainer
        uses: devcontainers/ci@v0.3
        with:
          imageName: ${{ env.DEVCONTAINER_IMAGE }}
          cacheFrom: ${{ env.DEVCONTAINER_IMAGE }}
          push: never
          env: |
            TEST_URL=http://localhost:8080
            SCREENSHOTS_DIR=./test-results/screenshots
            RESULTS_FILE=./test-results/results.json
          runCmd: |
            # Install dependencies
            npm install

            # Start local server in background
            http-server . -p 8080 &
            sleep 3
            curl -s http://localhost:8080 > /dev/null || (echo "Server failed to start" && exit 1)

            # Run Playwright tests
            mkdir -p test-results
            node tests/impatient-user-test.js

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-test-results
          path: test-results/
          retention-days: 7

  # Job 3: Claude reviews the Playwright test results and posts a comment
  # Uses prebuilt devcontainer with Claude CLI already installed
  impatient-user-review:
    name: Impatient User Review
    runs-on: ubuntu-latest
    needs: [check-author-authorization, build-devcontainer, run-playwright-tests]
    if: |
      always() &&
      github.event.pull_request.draft != true &&
      needs.check-author-authorization.outputs.authorized == 'true' &&
      needs.build-devcontainer.result == 'success'
    permissions:
      contents: read
      pull-requests: write
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.head_ref || github.ref }}

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: playwright-test-results
          path: test-results/

      - name: Create gh config directory for devcontainer mount
        run: mkdir -p ~/.config/gh

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Review test results with Claude
        uses: devcontainers/ci@v0.3
        with:
          imageName: ${{ env.DEVCONTAINER_IMAGE }}
          cacheFrom: ${{ env.DEVCONTAINER_IMAGE }}
          push: never
          env: |
            CLAUDE_CODE_OAUTH_TOKEN=${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
            GH_TOKEN=${{ secrets.WORKFLOW_PAT }}
            PR_NUMBER=${{ github.event.pull_request.number }}
          runCmd: |
            claude --print \
              --output-format stream-json \
              --model sonnet \
              --dangerously-skip-permissions \
              --max-turns 50 \
              "You are reviewing automated Playwright test results for the 'How Much Did It Cost Me?' web application.

            The test results are in test-results/results.json. Read this file to understand what happened.
            Screenshots from the test are in test-results/screenshots/.

            Your job is to:
            1. Read the test results JSON file
            2. Analyze what passed and what failed
            3. Post your review as a PR comment

            ## Response Format

            Structure your comment as:

            ## Impatient User Review

            **Status**: [PASSED or FAILED]

            ### First Visit (New User Flow)
            [Summary of first visit test - what worked, what didn't]

            ### Second Visit (Returning User Flow)
            [Summary of second visit test - was income remembered? Did the welcome banner appear?]

            ### Issues Found
            [List any issues, or 'None' if all tests passed]

            ## CRITICAL: Post Your Review

            After analyzing the results, you MUST post your review as a comment on PR #${PR_NUMBER} using:
            \`\`\`
            gh pr comment ${PR_NUMBER} --body 'YOUR_REVIEW_HERE'
            \`\`\`

            Use a heredoc for multi-line comments:
            \`\`\`
            gh pr comment ${PR_NUMBER} --body \"\$(cat <<'EOF'
            ## Impatient User Review
            ...your review content...
            EOF
            )\"
            \`\`\`" < /dev/null 2>&1 | tee ./impatient-review-output.jsonl

      - name: Upload review output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: impatient-review-output
          path: impatient-review-output.jsonl
          retention-days: 7

  # Job 4: Accuracy review - checks if any numbers in the PR are accurate
  # Uses prebuilt devcontainer with Claude CLI already installed
  accuracy-review:
    name: Data Accuracy Review
    runs-on: ubuntu-latest
    needs: [check-author-authorization, build-devcontainer]
    if: |
      github.event.pull_request.draft != true &&
      needs.check-author-authorization.outputs.authorized == 'true' &&
      needs.build-devcontainer.result == 'success'
    permissions:
      contents: read
      pull-requests: write
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.head_ref || github.ref }}
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          # Get the list of changed files in this PR
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          cat changed_files.txt

          # Check if data.js was modified
          if grep -q "js/data.js" changed_files.txt; then
            echo "data_changed=true" >> $GITHUB_OUTPUT
          else
            echo "data_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create gh config directory for devcontainer mount
        if: steps.changed-files.outputs.data_changed == 'true'
        run: mkdir -p ~/.config/gh

      - name: Log in to GHCR
        if: steps.changed-files.outputs.data_changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Review data accuracy with Claude
        if: steps.changed-files.outputs.data_changed == 'true'
        uses: devcontainers/ci@v0.3
        with:
          imageName: ${{ env.DEVCONTAINER_IMAGE }}
          cacheFrom: ${{ env.DEVCONTAINER_IMAGE }}
          push: never
          env: |
            CLAUDE_CODE_OAUTH_TOKEN=${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
            GH_TOKEN=${{ secrets.WORKFLOW_PAT }}
            PR_NUMBER=${{ github.event.pull_request.number }}
          runCmd: |
            claude --print \
              --output-format stream-json \
              --model sonnet \
              --dangerously-skip-permissions \
              --max-turns 100 \
              "You are a data accuracy reviewer for the 'How Much Did It Cost Me?' application.

            This PR modifies js/data.js which contains critical financial data:
            - Federal income tax brackets and rates
            - Standard deduction amounts
            - FICA/payroll tax rates and thresholds
            - Federal budget figures (revenue and spending)
            - Notable spending examples with their costs

            ## Your Task

            1. Read js/data.js to see the current values
            2. Use web search to verify the accuracy of ANY numbers that were changed in this PR
            3. Post your findings as a PR comment

            ## Verification Checklist

            For tax data, verify against:
            - IRS official publications for the tax year specified
            - Tax Foundation or similar authoritative sources

            For budget data, verify against:
            - Congressional Budget Office (CBO) reports
            - U.S. Treasury fiscal data
            - OMB budget documents

            For spending examples, verify against:
            - Official government sources (NASA, DoD, USDA, etc.)
            - Congressional Research Service reports
            - Reputable news sources

            ## Response Format

            Structure your comment as:

            ## Data Accuracy Review

            **Status**: [VERIFIED / ISSUES FOUND / UNABLE TO VERIFY]

            ### Changes Reviewed
            [List the specific data changes in this PR]

            ### Verification Results
            [For each changed value, state whether it's accurate and cite your source]

            ### Recommendations
            [Any suggested corrections or additional verification needed]

            ---
            *Sources checked: [list sources consulted]*

            ## CRITICAL: Post Your Review

            After completing your analysis, you MUST post your review as a comment on PR #${PR_NUMBER} using:
            \`\`\`
            gh pr comment ${PR_NUMBER} --body \"\$(cat <<'EOF'
            ## Data Accuracy Review
            ...your review content...
            EOF
            )\"
            \`\`\`" < /dev/null 2>&1 | tee ./accuracy-review-output.jsonl

      - name: Upload review output
        uses: actions/upload-artifact@v4
        if: steps.changed-files.outputs.data_changed == 'true'
        with:
          name: accuracy-review-output
          path: accuracy-review-output.jsonl
          retention-days: 7

      - name: Skip if no data changes
        if: steps.changed-files.outputs.data_changed != 'true'
        run: |
          echo "No changes to js/data.js - skipping accuracy review"

  # Job 5: Execute test plan from PR description
  # If the PR has a "Test plan" section, Claude will execute those steps with Playwright
  # Uses prebuilt devcontainer with Claude CLI and Playwright already installed
  test-plan-executor:
    name: Test Plan Executor
    runs-on: ubuntu-latest
    needs: [check-author-authorization, build-devcontainer]
    if: |
      github.event.pull_request.draft != true &&
      needs.check-author-authorization.outputs.authorized == 'true' &&
      needs.build-devcontainer.result == 'success'
    permissions:
      contents: read
      pull-requests: write
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.head_ref || github.ref }}

      - name: Extract test plan from PR
        id: extract-test-plan
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Save PR body to file for processing
          echo "$PR_BODY" > pr_body.txt

          # Check if there's a test plan section (case insensitive)
          # Look for "## Test plan", "## Test Plan", "### Test plan", etc.
          if grep -qi "test plan" pr_body.txt; then
            echo "has_test_plan=true" >> $GITHUB_OUTPUT

            # Extract the test plan section (everything after "Test plan" header until next ## header or end)
            sed -n '/[Tt]est [Pp]lan/,/^##[^#]/p' pr_body.txt | head -n -1 > test_plan.txt

            # If extraction is empty, try alternative: get everything after "Test plan"
            if [ ! -s test_plan.txt ]; then
              sed -n '/[Tt]est [Pp]lan/,$p' pr_body.txt > test_plan.txt
            fi

            echo "Test plan found:"
            cat test_plan.txt
          else
            echo "has_test_plan=false" >> $GITHUB_OUTPUT
            echo "No test plan section found in PR description"
          fi

      - name: Create gh config directory for devcontainer mount
        if: steps.extract-test-plan.outputs.has_test_plan == 'true'
        run: mkdir -p ~/.config/gh

      - name: Log in to GHCR
        if: steps.extract-test-plan.outputs.has_test_plan == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Write PR body to file for devcontainer
        if: steps.extract-test-plan.outputs.has_test_plan == 'true'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "$PR_BODY" > pr_body_for_claude.txt

      - name: Execute test plan with Claude in devcontainer
        if: steps.extract-test-plan.outputs.has_test_plan == 'true'
        uses: devcontainers/ci@v0.3
        with:
          imageName: ${{ env.DEVCONTAINER_IMAGE }}
          cacheFrom: ${{ env.DEVCONTAINER_IMAGE }}
          push: never
          env: |
            CLAUDE_CODE_OAUTH_TOKEN=${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
            GH_TOKEN=${{ secrets.WORKFLOW_PAT }}
            PR_NUMBER=${{ github.event.pull_request.number }}
          runCmd: |
            # Start local server in background
            http-server . -p 8080 &
            sleep 3
            curl -s http://localhost:8080 > /dev/null || (echo "Server failed to start" && exit 1)

            # Read PR body for the prompt
            PR_BODY_CONTENT=$(cat pr_body_for_claude.txt)

            # Run Claude to execute the test plan
            claude --print \
              --output-format stream-json \
              --model sonnet \
              --dangerously-skip-permissions \
              --max-turns 200 \
              "You are a test executor. The PR author has provided a test plan that you need to execute.

            The app is running at http://localhost:8080

            ## Test Plan from PR Description

            The following test plan was specified by the PR author:

            \`\`\`
            ${PR_BODY_CONTENT}
            \`\`\`

            Look for the 'Test plan' section in the PR description above and execute each step.

            ## Your Task

            1. Read and understand each test step in the test plan
            2. Use Playwright to execute each step against the running app
            3. Take screenshots at key points
            4. Post your results as a PR comment

            ## Execution Guidelines

            - Use the playwright-skill or write Playwright scripts to test the app
            - The app is a single-page web application at http://localhost:8080
            - Key elements: #income (input), #spending (input), #taxResult, #resultShare
            - Category buttons have data-category attributes (defense, general, socialSecurity, medicare, interest)
            - Take screenshots to document your testing

            ## Response Format

            Structure your comment as:

            ## Test Plan Execution

            **Status**: [PASSED / FAILED / PARTIAL]

            ### Steps Executed
            [For each step in the test plan, report: Passed or Failed with details]

            ### Evidence
            [Reference screenshots taken during testing]

            ### Notes
            [Any observations or issues discovered]

            ## CRITICAL: Post Your Review

            After executing the test plan, you MUST post your results as a comment on PR #${PR_NUMBER} using:
            \`\`\`
            gh pr comment ${PR_NUMBER} --body \"\$(cat <<'EOF'
            ## Test Plan Execution
            ...your results...
            EOF
            )\"
            \`\`\`

            IMPORTANT:
            - Execute the EXACT steps specified in the test plan
            - Don't skip steps or make assumptions
            - If a step is unclear, note it but attempt to execute your best interpretation
            - Report honestly if something fails" < /dev/null 2>&1 | tee ./test-plan-output.jsonl

      - name: Upload test plan output
        uses: actions/upload-artifact@v4
        if: steps.extract-test-plan.outputs.has_test_plan == 'true'
        with:
          name: test-plan-output
          path: test-plan-output.jsonl
          retention-days: 7

      - name: Skip if no test plan
        if: steps.extract-test-plan.outputs.has_test_plan != 'true'
        run: |
          echo "No test plan section found in PR description - skipping test plan execution"

  # Gate job - ensures all agent reviews pass before merge
  all-agent-reviews-passed:
    name: All Agent Reviews
    runs-on: ubuntu-latest
    needs: [check-author-authorization, build-devcontainer, run-unit-tests, run-playwright-tests, impatient-user-review, accuracy-review, test-plan-executor]
    if: always()
    steps:
      - name: Check all reviews passed
        run: |
          echo "Checking results of all agent reviews..."
          echo "check-author-authorization: ${{ needs.check-author-authorization.result }}"
          echo "build-devcontainer: ${{ needs.build-devcontainer.result }}"
          echo "run-unit-tests: ${{ needs.run-unit-tests.result }}"
          echo "run-playwright-tests: ${{ needs.run-playwright-tests.result }}"
          echo "impatient-user-review: ${{ needs.impatient-user-review.result }}"
          echo "accuracy-review: ${{ needs.accuracy-review.result }}"
          echo "test-plan-executor: ${{ needs.test-plan-executor.result }}"

          # Authorization check must pass
          if [ "${{ needs.check-author-authorization.result }}" != "success" ]; then
            echo "FAILED: Author authorization check did not succeed"
            exit 1
          fi

          # Devcontainer build must pass
          if [ "${{ needs.build-devcontainer.result }}" != "success" ]; then
            echo "FAILED: Devcontainer build did not succeed"
            exit 1
          fi

          # Check if author was authorized
          AUTHORIZED="${{ needs.check-author-authorization.outputs.authorized }}"
          if [ "$AUTHORIZED" != "true" ]; then
            echo "SKIPPED: PR author is not authorized - Claude reviews were skipped for security"
            echo "::warning::Claude review jobs were skipped because PR author does not have write access"
            # Still pass the gate - Playwright tests ran, just no Claude reviews
          fi

          # Unit tests must pass
          if [ "${{ needs.run-unit-tests.result }}" != "success" ]; then
            echo "FAILED: Unit tests did not succeed"
            exit 1
          fi

          # Playwright tests must pass
          if [ "${{ needs.run-playwright-tests.result }}" != "success" ]; then
            echo "FAILED: Playwright tests did not succeed"
            exit 1
          fi

          # Impatient user review must complete (success or skipped is ok)
          if [ "${{ needs.impatient-user-review.result }}" == "failure" ]; then
            echo "FAILED: impatient-user-review failed"
            exit 1
          fi

          # Accuracy review must complete (success or skipped is ok)
          if [ "${{ needs.accuracy-review.result }}" == "failure" ]; then
            echo "FAILED: accuracy-review failed"
            exit 1
          fi

          # Test plan executor must complete (success or skipped is ok)
          if [ "${{ needs.test-plan-executor.result }}" == "failure" ]; then
            echo "FAILED: test-plan-executor failed"
            exit 1
          fi

          echo "All agent reviews passed!"
